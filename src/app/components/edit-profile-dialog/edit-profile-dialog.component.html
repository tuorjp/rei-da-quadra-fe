<div mat-dialog-title class="custom-dialog-header">
  <h2>{{ isCropping ? 'Ajustar Imagem' : 'Editar Perfil' }}</h2>
  <p class="dialog-subtitle" *ngIf="!isCropping">Atualize suas informações pessoais</p>
</div>

<mat-dialog-content class="custom-dialog-content">

  <div *ngIf="isCropping" class="cropper-wrapper">
    <div class="cropper-box">
      <image-cropper
        [imageChangedEvent]="imageChangedEvent"
        [maintainAspectRatio]="true"
        [aspectRatio]="1 / 1"
        format="png"
        [resizeToWidth]="256"
        (imageCropped)="imageCropped($event)"
        (imageLoaded)="imageLoaded($event)"
        (cropperReady)="cropperReady()"
        (loadImageFailed)="loadImageFailed()"
      ></image-cropper>
    </div>

    <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
      <button mat-button (click)="cancelCrop()" class="cancel-btn">Cancelar</button>
      <button mat-flat-button color="primary" (click)="confirmCrop()">
        <mat-icon>check</mat-icon> Confirmar
      </button>
    </div>
  </div>

  <div *ngIf="!isCropping">

    <div class="section-profile">
      <div class="avatar-wrapper">
        <div class="avatar-container">
          <img *ngIf="previewPhoto" [src]="previewPhoto" class="avatar-img" alt="Avatar Preview">
          <div *ngIf="!previewPhoto" class="avatar-placeholder">
            <mat-icon class="avatar-icon">person</mat-icon>
          </div>

          <button mat-mini-fab color="primary" class="camera-btn" (click)="fileInput.click()" matTooltip="Alterar foto">
            <mat-icon>photo_camera</mat-icon>
          </button>
          <input #fileInput type="file" hidden (change)="onFileSelected($event)" accept="image/*">
        </div>

        <button *ngIf="previewPhoto" class="remove-btn" (click)="removePhoto()">
          <mat-icon>delete_outline</mat-icon>
          Remover foto
        </button>
      </div>

      <form [formGroup]="form" class="edit-form" style="width: 100%;">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nome Completo</mat-label>
          <mat-icon matPrefix class="input-icon">badge</mat-icon>
          <input matInput formControlName="nome" placeholder="Seu nome" maxlength="30">
          <mat-error *ngIf="checkError('nome', 'required')">Nome é obrigatório</mat-error>
          <mat-error *ngIf="checkError('nome', 'maxlength')">Máximo de 30 caracteres</mat-error>
        </mat-form-field>
        </mat-form-field>
      </form>
    </div>

    <div class="section-security">
      <div class="section-header-text">
        <mat-icon>lock</mat-icon>
        <h3>Segurança</h3>
      </div>
      <p class="section-desc">Preencha apenas se desejar alterar sua senha atual.</p>

      <form [formGroup]="form" class="edit-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nova Senha</mat-label>
          <mat-icon matPrefix class="input-icon">lock_open</mat-icon>
          <input matInput formControlName="senha" [type]="hidePassword ? 'password' : 'text'">
          <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="checkError('senha', 'minlength')">Mínimo 6 caracteres</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirmar Nova Senha</mat-label>
          <mat-icon matPrefix class="input-icon">lock</mat-icon>
          <input matInput formControlName="confirmarSenha" [type]="hideConfirmPassword ? 'password' : 'text'">
          <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
            <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="form.get('confirmarSenha')?.hasError('passwordMismatch')">
            As senhas não coincidem
          </mat-error>
        </mat-form-field>
      </form>
    </div>

  </div>

</mat-dialog-content>

<mat-dialog-actions align="end" class="custom-dialog-actions" *ngIf="!isCropping">
  <button mat-button (click)="onCancel()" class="cancel-btn">Cancelar</button>
  <button mat-flat-button color="primary" [disabled]="form.invalid" (click)="onSave()">
    Salvar Alterações
  </button>
</mat-dialog-actions>
